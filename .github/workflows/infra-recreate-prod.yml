name: Recreate Prod (CDKTF)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type RECREATE to confirm you want to destroy and recreate the prod environment"
        required: true
        type: string

jobs:
  recreate:
    runs-on: ubuntu-latest
    environment:
      name: gridpulse/prod
    env:
      TF_CLOUD_ORG: ${{ secrets.TF_CLOUD_ORG }}
      TF_CLOUD_WORKSPACE: gridpulse-prod
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
    steps:
      - name: Guard confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "RECREATE" ]; then
            echo "Confirmation mismatch. Type RECREATE exactly to proceed." >&2
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.7.5'

      - name: Install sops and age
        run: |
          sudo apt-get update
          sudo apt-get install -y age
          SOPS_VERSION=v3.8.1
          curl -Ls https://github.com/getsops/sops/releases/download/$SOPS_VERSION/sops-$SOPS_VERSION.linux.amd64 -o sops
          sudo install -m 0755 sops /usr/local/bin/sops

      - name: Decrypt or generate tfvars
        env:
          AGE_PRIVATE_KEY: ${{ secrets.AGE_PRIVATE_KEY }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          EIA_API_KEY: ${{ secrets.EIA_API_KEY }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/sops/age
          if [ -n "${AGE_PRIVATE_KEY:-}" ]; then
            printf "%s\n" "$AGE_PRIVATE_KEY" > ~/.config/sops/age/keys.txt
          fi
          if [ -f secrets/prod.enc.tfvars ]; then
            echo "Preparing terraform.tfvars from secrets/prod.enc.tfvars"
            if sops -d secrets/prod.enc.tfvars >/dev/null 2>&1; then
              sops -d secrets/prod.enc.tfvars > infrastructure/cdktf/terraform.tfvars
            else
              echo "Warning: prod.enc.tfvars not encrypted or decryption failed; will fall back to GH secrets."
            fi
          fi
          if [ ! -f infrastructure/cdktf/terraform.tfvars ]; then
            echo "Generating terraform.tfvars from GitHub environment secrets..."
            {
              echo "railway_token     = \"${{ secrets.RAILWAY_TOKEN }}\""
              echo "project_id        = \"${{ secrets.RAILWAY_PROJECT_ID }}\""
              echo "postgres_password = \"${{ secrets.POSTGRES_PASSWORD }}\""
              echo "session_secret    = \"${{ secrets.SESSION_SECRET }}\""
              echo "eia_api_key       = \"${{ secrets.EIA_API_KEY }}\""
              echo
              echo "docker_image    = \"\""
              echo "docker_username = \"\""
              echo "docker_password = \"\""
            } > infrastructure/cdktf/terraform.tfvars
          fi

      - name: Install CDKTF deps
        working-directory: infrastructure/cdktf
        run: |
          npm ci
          npm run get
          npm run compile

      - name: Destroy prod (cdktf)
        working-directory: infrastructure/cdktf
        run: |
          set +e
          echo "Destroying gridpulse-prod stack (ignoring failures if state is missing)..."
          npx cdktf destroy gridpulse-prod --auto-approve -var-file="terraform.tfvars"
          code=$?
          set -e
          if [ "$code" -ne 0 ]; then
            echo "Destroy reported errors (likely due to missing state). Will attempt CLI force delete next."
          fi

      - name: Force delete Railway environment via CLI (best-effort)
        env:
          ENV_NAME: prod
        run: |
          set -euo pipefail
          echo "Installing Railway CLI..."
          npm i -g @railway/cli || npm i -g railway

          echo "Extracting tokens and project_id from terraform.tfvars..."
          # Prefer railway_project_token if present; else railway_token
          RAILWAY_PROJECT_TOKEN=$(awk -F'=' '/^\s*railway_project_token\s*=/{gsub(/"| /, "", $2); print $2}' infrastructure/cdktf/terraform.tfvars || true)
          RAILWAY_ACCOUNT_TOKEN=$(awk -F'=' '/^\s*railway_token\s*=/{gsub(/"| /, "", $2); print $2}' infrastructure/cdktf/terraform.tfvars || true)
          PROJECT_ID=$(awk -F'=' '/^\s*project_id\s*=/{gsub(/"| /, "", $2); print $2}' infrastructure/cdktf/terraform.tfvars)
          TOKEN_TO_USE=${RAILWAY_PROJECT_TOKEN:-}
          if [ -z "$TOKEN_TO_USE" ]; then TOKEN_TO_USE="$RAILWAY_ACCOUNT_TOKEN"; fi
          if [ -z "$TOKEN_TO_USE" ]; then
            echo "No Railway token found in terraform.tfvars; skipping CLI force delete."
            exit 0
          fi
          # Export token for CLI to use (preferred over writing config files)
          export RAILWAY_TOKEN="$TOKEN_TO_USE"
          echo "Railway CLI version: $(railway --version)"
          # Optional sanity: whoami (won't print token)
          railway whoami || true

          echo "Linking project $PROJECT_ID..."
          railway link --project "$PROJECT_ID"
          echo "Attempting to delete environment '$ENV_NAME'..."
          set +e
          railway environment delete "$ENV_NAME" -y
          code=$?
          set -e
          if [ "$code" -ne 0 ]; then
            echo "Environment delete may have failed or not existed; proceeding."
          else
            echo "Environment '$ENV_NAME' delete requested."
          fi

      - name: Deploy prod (cdktf)
        working-directory: infrastructure/cdktf
        run: |
          set -e
          echo "Re-deploying gridpulse-prod stack..."
          npx cdktf deploy gridpulse-prod --auto-approve -var-file="terraform.tfvars"
